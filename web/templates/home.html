<html>
<head>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>

  <script>
  let web3 = new Web3(Web3.givenProvider);
  window.ethereum.enable();

  const contract_address = "{{ exercise_token_claim.address }}";
  const abi = {{ exercise_token_claim.abi|tojson|safe }};

  const token_address = "{{ exercise_token.address }}";
  const token_abi = {{ exercise_token.abi|tojson|safe }};


  function claimTokens() {

    web3.eth.getAccounts().then(function (accounts) {
      let contract = new web3.eth.Contract(abi, contract_address);
      contract.methods.claimTokens()
          .send({from: accounts[0], gasPrice: web3.utils.toWei('4.1', 'Gwei')})
          .then(console.log)
          .catch(console.log);
    });
  }

  function initPage() {

    web3.eth.getAccounts().then(function (accounts) {
      let token_contract = new web3.eth.Contract(token_abi, token_address);
      token_contract.methods.balanceOf(accounts[0]).call().then(function (balance) {
        $("#token-balance").html(balance);
      });

      jQuery.get("/is-registered/?address=" + accounts[0]).done(function() {
          $("#register-link").hide();
      })
      .fail(function() {
          $("#claim-tokens").hide();
      });

    });
  }
  initPage();


  </script>

</head>
<body>
  <h1>Exercise Token</h1>

  <p><a id="register-link" href="/oauth2request/">REGISTER HERE</a></p>

  <h2>EXERCISE TOKEN BALANCE = <span id="token-balance">--</span> EXT</h2>

  <button id="claim-tokens" onclick="claimTokens()">CLAIM TOKENS</button>


</body>
</html>
